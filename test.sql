-- ==========================================================
-- 1. CONEXIÓN Y CREACIÓN DEL USUARIO (Ejecutar como SYSTEM)
-- ==========================================================
-- Si ya creaste el usuario FISEI y te dio errores, 
-- ignora el error de "usuario ya existe" o borralo primero manualmente.
CONNECT SYSTEM/ROOT;

DROP USER FISEI CASCADE;

CREATE USER FISEI IDENTIFIED BY FISEI123;
GRANT CONNECT, RESOURCE, DBA TO FISEI;

CONNECT FISEI/FISEI123;

-- ==========================================================
-- 2. LIMPIEZA Y CREACIÓN DE TABLAS (DDL - ORACLE 10g)
-- ==========================================================
-- Nota: No dejar lineas en blanco DENTRO de los parentesis

ALTER SESSION SET NLS_DATE_FORMAT = 'DD/MM/YYYY HH24:MI:SS';

-- Bloque para limpiar tablas antiguas
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE CHAT CASCADE CONSTRAINTS';
  EXECUTE IMMEDIATE 'DROP TABLE SOLICITUD_AMISTAD CASCADE CONSTRAINTS';
  EXECUTE IMMEDIATE 'DROP TABLE REACCIONES_A_COMENTARIOS CASCADE CONSTRAINTS';
  EXECUTE IMMEDIATE 'DROP TABLE COMENTARIOS_PUBLICACIONES CASCADE CONSTRAINTS';
  EXECUTE IMMEDIATE 'DROP TABLE REACCION_APUBLICACION CASCADE CONSTRAINTS';
  EXECUTE IMMEDIATE 'DROP TABLE PUBLICACIONES CASCADE CONSTRAINTS';
  EXECUTE IMMEDIATE 'DROP TABLE REACCIONES CASCADE CONSTRAINTS';
  EXECUTE IMMEDIATE 'DROP TABLE USUARIOS CASCADE CONSTRAINTS';
EXCEPTION
  WHEN OTHERS THEN NULL;
END;
/

CREATE TABLE USUARIOS (
  ID_USU VARCHAR2(10) PRIMARY KEY,
  NOM_USU VARCHAR2(50),
  APE_USU VARCHAR2(50),
  FEC_NAC_USU DATE,
  IMG_PERF VARCHAR2(500),
  COR_USU VARCHAR2(100)
);

CREATE TABLE REACCIONES (
  ID_REA VARCHAR2(5) PRIMARY KEY,
  NOM_REAC VARCHAR2(20)
);

CREATE TABLE PUBLICACIONES (
  ID_PUB NUMBER PRIMARY KEY,
  TIP_PUB VARCHAR2(20),
  ID_USU_CREO VARCHAR2(10),
  FEC_HOR_PUB DATE,
  DES_PUB VARCHAR2(255),
  DESC_COMP VARCHAR2(255),
  ID_PUB_ORI NUMBER,
  CONSTRAINT FK_PUB_USU FOREIGN KEY (ID_USU_CREO) REFERENCES USUARIOS(ID_USU),
  CONSTRAINT FK_PUB_ORI FOREIGN KEY (ID_PUB_ORI) REFERENCES PUBLICACIONES(ID_PUB)
);

CREATE TABLE REACCION_APUBLICACION (
  ID_PUB_REA NUMBER,
  ID_REA VARCHAR2(5),
  FEC_HOR_REA DATE,
  USU_REA VARCHAR2(10),
  CONSTRAINT FK_RP_PUB FOREIGN KEY (ID_PUB_REA) REFERENCES PUBLICACIONES(ID_PUB),
  CONSTRAINT FK_RP_REA FOREIGN KEY (ID_REA) REFERENCES REACCIONES(ID_REA),
  CONSTRAINT FK_RP_USU FOREIGN KEY (USU_REA) REFERENCES USUARIOS(ID_USU)
);

CREATE TABLE COMENTARIOS_PUBLICACIONES (
  ID_COM NUMBER PRIMARY KEY,
  TEXTO_COM VARCHAR2(500),
  ID_USU VARCHAR2(10),
  FEC_HOR_COM DATE,
  ID_PUB_COM NUMBER,
  ID_COM_RES NUMBER,
  CONSTRAINT FK_COM_USU FOREIGN KEY (ID_USU) REFERENCES USUARIOS(ID_USU),
  CONSTRAINT FK_COM_PUB FOREIGN KEY (ID_PUB_COM) REFERENCES PUBLICACIONES(ID_PUB),
  CONSTRAINT FK_COM_RES FOREIGN KEY (ID_COM_RES) REFERENCES COMENTARIOS_PUBLICACIONES(ID_COM)
);

CREATE TABLE REACCIONES_A_COMENTARIOS (
  ID_COM_REA NUMBER,
  ID_REA_SEL VARCHAR2(5),
  FEC_HOR_REA DATE,
  USU_REA VARCHAR2(10),
  CONSTRAINT FK_RC_COM FOREIGN KEY (ID_COM_REA) REFERENCES COMENTARIOS_PUBLICACIONES(ID_COM),
  CONSTRAINT FK_RC_REA FOREIGN KEY (ID_REA_SEL) REFERENCES REACCIONES(ID_REA),
  CONSTRAINT FK_RC_USU FOREIGN KEY (USU_REA) REFERENCES USUARIOS(ID_USU)
);

CREATE TABLE SOLICITUD_AMISTAD (
  ID_SOL NUMBER PRIMARY KEY,
  ID_USU_SOL VARCHAR2(10),
  ID_USU_REC VARCHAR2(10),
  FEC_HOR_SOL DATE,
  ESTADO_SOL VARCHAR2(20) CHECK (ESTADO_SOL IN ('ENVIADA', 'ACEPTADA', 'RECHAZADA')),
  FEC_RESP_SOL DATE,
  CONSTRAINT FK_SOL_ENV FOREIGN KEY (ID_USU_SOL) REFERENCES USUARIOS(ID_USU),
  CONSTRAINT FK_SOL_REC FOREIGN KEY (ID_USU_REC) REFERENCES USUARIOS(ID_USU)
);

CREATE TABLE CHAT (
  ID_MSG NUMBER PRIMARY KEY,
  TEXTO_MSG VARCHAR2(500),
  ESTADO_MSG VARCHAR2(20) CHECK (ESTADO_MSG IN ('ENVIADO', 'LEIDO')),
  ID_USU_ENV VARCHAR2(10),
  FEC_HOR_ENV DATE,
  ID_USU_REC VARCHAR2(10),
  FEC_HOR_REC DATE,
  ID_MSG_RES NUMBER,
  CONSTRAINT FK_CHAT_ENV FOREIGN KEY (ID_USU_ENV) REFERENCES USUARIOS(ID_USU),
  CONSTRAINT FK_CHAT_REC FOREIGN KEY (ID_USU_REC) REFERENCES USUARIOS(ID_USU),
  CONSTRAINT FK_CHAT_RES FOREIGN KEY (ID_MSG_RES) REFERENCES CHAT(ID_MSG)
);

-- ==========================================================
-- 3. INSERCIÓN DE DATOS (DML)
-- ==========================================================

INSERT INTO USUARIOS VALUES ('U01', 'ANA', 'MERA', TO_DATE('15/02/2005','DD/MM/YYYY'), 'https://img.com/u01.jpg', 'am@uta.edu.ec');
INSERT INTO USUARIOS VALUES ('U02', 'LUIS', 'SANCHEZ', TO_DATE('17/08/2008','DD/MM/YYYY'), 'https://img.com/u02.jpg', 'ls@uta.edu.ec');
INSERT INTO USUARIOS VALUES ('U03', 'JUAN', 'PEREZ', TO_DATE('01/01/2000','DD/MM/YYYY'), 'https://img.com/def.jpg', 'jp@uta.edu.ec');
INSERT INTO USUARIOS VALUES ('U04', 'MARIA', 'LOPEZ', TO_DATE('05/05/2001','DD/MM/YYYY'), 'https://img.com/def.jpg', 'ml@uta.edu.ec');
INSERT INTO USUARIOS VALUES ('U08', 'PEDRO', 'RUIZ', TO_DATE('10/10/2002','DD/MM/YYYY'), NULL, 'pr@uta.edu.ec');
INSERT INTO USUARIOS VALUES ('U09', 'JOSE', 'DIAZ', TO_DATE('10/10/2002','DD/MM/YYYY'), NULL, 'jd@uta.edu.ec');
INSERT INTO USUARIOS VALUES ('U10', 'CARLA', 'PAZ', TO_DATE('10/10/2002','DD/MM/YYYY'), NULL, 'cp@uta.edu.ec');
INSERT INTO USUARIOS VALUES ('U12', 'BETO', 'SOL', TO_DATE('10/10/2002','DD/MM/YYYY'), NULL, 'bs@uta.edu.ec');

INSERT INTO REACCIONES VALUES ('MG', 'ME GUSTA');
INSERT INTO REACCIONES VALUES ('MD', 'ME DISGUSTA');
INSERT INTO REACCIONES VALUES ('ME', 'ME ENCANTA');

INSERT INTO PUBLICACIONES VALUES (4232, 'IMAGEN', 'U01', TO_DATE('01/12/2025 07:00','DD/MM/YYYY HH24:MI'), 'IMPORTANTE', NULL, NULL);
INSERT INTO PUBLICACIONES VALUES (5555, 'IMAGEN', 'U02', TO_DATE('01/12/2025 10:00','DD/MM/YYYY HH24:MI'), NULL, 'COLABORADOR', 4232);
INSERT INTO PUBLICACIONES VALUES (7777, 'IMAGEN', 'U03', TO_DATE('01/12/2025 11:00','DD/MM/YYYY HH24:MI'), NULL, 'OJO AMIGOS', 4232);
INSERT INTO PUBLICACIONES VALUES (8888, 'IMAGEN', 'U04', TO_DATE('01/12/2025 11:30','DD/MM/YYYY HH24:MI'), NULL, 'BUENA OFERTA', 5555);

INSERT INTO REACCION_APUBLICACION VALUES (4232, 'MG', TO_DATE('01/12/2025 07:01:08','DD/MM/YYYY HH24:MI:SS'), 'U02');
INSERT INTO REACCION_APUBLICACION VALUES (4232, 'MD', TO_DATE('01/12/2025 07:02:20','DD/MM/YYYY HH24:MI:SS'), 'U02');
INSERT INTO REACCION_APUBLICACION VALUES (4232, 'MG', TO_DATE('01/12/2025 07:03:04','DD/MM/YYYY HH24:MI:SS'), 'U02');

INSERT INTO COMENTARIOS_PUBLICACIONES VALUES (9788, 'PRECIO', 'U03', TO_DATE('14/12/2025 11:50:08','DD/MM/YYYY HH24:MI:SS'), 5555, NULL);
INSERT INTO COMENTARIOS_PUBLICACIONES VALUES (9789, 'FIJATE BIEN', 'U09', TO_DATE('14/12/2025 11:51:08','DD/MM/YYYY HH24:MI:SS'), NULL, 9788);
INSERT INTO COMENTARIOS_PUBLICACIONES VALUES (9790, 'FIJATE BIEN x2', 'U10', TO_DATE('14/12/2025 11:52:12','DD/MM/YYYY HH24:MI:SS'), NULL, 9789);
INSERT INTO COMENTARIOS_PUBLICACIONES VALUES (9791, '500 USD', 'U12', TO_DATE('14/12/2025 11:53:08','DD/MM/YYYY HH24:MI:SS'), NULL, 9788);

INSERT INTO REACCIONES_A_COMENTARIOS VALUES (9791, 'MG', TO_DATE('14/12/2025 11:55:00','DD/MM/YYYY HH24:MI:SS'), 'U08');

INSERT INTO SOLICITUD_AMISTAD VALUES (143423, 'U04', 'U01', TO_DATE('01/12/2025 11:55:08','DD/MM/YYYY HH24:MI:SS'), 'ACEPTADA', TO_DATE('02/12/2025 11:00:08','DD/MM/YYYY HH24:MI:SS'));
INSERT INTO SOLICITUD_AMISTAD VALUES (143424, 'U01', 'U02', TO_DATE('01/01/2020 10:00:00','DD/MM/YYYY HH24:MI:SS'), 'ACEPTADA', TO_DATE('02/01/2020 10:00:00','DD/MM/YYYY HH24:MI:SS'));

INSERT INTO CHAT VALUES (789, 'HOLA', 'LEIDO', 'U04', TO_DATE('14/12/2025 11:55:08','DD/MM/YYYY HH24:MI:SS'), 'U02', TO_DATE('14/12/2025 11:57:08','DD/MM/YYYY HH24:MI:SS'), NULL);
INSERT INTO CHAT VALUES (790, 'TIENES EL DEBER', 'LEIDO', 'U04', TO_DATE('14/12/2025 11:56:08','DD/MM/YYYY HH24:MI:SS'), 'U02', TO_DATE('14/12/2025 11:56:08','DD/MM/YYYY HH24:MI:SS'), NULL);
INSERT INTO CHAT VALUES (791, 'SI', 'LEIDO', 'U02', TO_DATE('14/12/2025 11:58:08','DD/MM/YYYY HH24:MI:SS'), 'U04', TO_DATE('14/12/2025 11:58:08','DD/MM/YYYY HH24:MI:SS'), 790);

COMMIT;

-- 1. Ampliamos el ancho de la línea de la consola
SET LINESIZE 200

-- 2. Aumentamos el tamaño de página para que no repita los encabezados a cada rato
SET PAGESIZE 100

-- 3. IMPORTANTE: Formateamos las columnas para que no ocupen espacio innecesario
-- "FORMAT A30" significa que la columna de texto ocupará solo 30 caracteres de ancho visualmente
COLUMN ID_PUBLICACION FORMAT 9999 HEADING "ID"
COLUMN CONTENIDO FORMAT A30 WORD_WRAPPED HEADING "Contenido"
COLUMN DES_PUB FORMAT A30 WORD_WRAPPED HEADING "Descripcion Pub"
COLUMN TEXTO_COM FORMAT A30 WORD_WRAPPED HEADING "Comentario"
COLUMN CANTIDAD_LIKES FORMAT 9999 HEADING "Likes"
COLUMN COMENTARIOS_FAVORABLES FORMAT 9999 HEADING "Com. Fav."
COLUMN VECES_COMPARTIDA FORMAT 9999 HEADING "Compartido"
COLUMN ID_USU_SOL FORMAT A10 HEADING "Solicitante"
COLUMN ID_USU_REC FORMAT A10 HEADING "Receptor"
COLUMN ANIOS_AMISTAD FORMAT 99.9 HEADING "Anios"

-- ==========================================================
-- 4. REPORTES (ADAPTADOS PARA ORACLE 10g)
-- ==========================================================
SET LINESIZE100;
SET PAGESIZE100;
-- 1. Amigos de U01
SELECT COUNT(*) AS TOTAL_AMIGOS_U01
FROM SOLICITUD_AMISTAD
WHERE ESTADO_SOL = 'ACEPTADA'
  AND (ID_USU_SOL = 'U01' OR ID_USU_REC = 'U01');

-- 2. Anios de amistad U01 y U02
SELECT TRUNC(MONTHS_BETWEEN(SYSDATE, FEC_RESP_SOL) / 12, 1) AS ANIOS_AMISTAD
FROM SOLICITUD_AMISTAD
WHERE ESTADO_SOL = 'ACEPTADA'
  AND ((ID_USU_SOL = 'U01' AND ID_USU_REC = 'U02') OR (ID_USU_SOL = 'U02' AND ID_USU_REC = 'U01'));

-- 3. Publicacion mas gustada U01 (2025)
SELECT * FROM (
    SELECT P.ID_PUB, P.DES_PUB, COUNT(R.ID_REA) AS CANTIDAD_LIKES
    FROM PUBLICACIONES P
    JOIN REACCION_APUBLICACION R ON P.ID_PUB = R.ID_PUB_REA
    WHERE P.ID_USU_CREO = 'U01'
      AND EXTRACT(YEAR FROM P.FEC_HOR_PUB) = 2025
      AND R.ID_REA = 'MG'
    GROUP BY P.ID_PUB, P.DES_PUB
    ORDER BY CANTIDAD_LIKES DESC
) WHERE ROWNUM = 1;

-- 4. Publicacion con comentarios favorables
SELECT * FROM (
    SELECT P.ID_PUB, P.DES_PUB, COUNT(C.ID_COM) AS COMENTARIOS_FAVORABLES
    FROM PUBLICACIONES P
    JOIN COMENTARIOS_PUBLICACIONES C ON P.ID_PUB = C.ID_PUB_COM
    WHERE (UPPER(C.TEXTO_COM) LIKE '%BUEN%' 
        OR UPPER(C.TEXTO_COM) LIKE '%EXCELENTE%' 
        OR UPPER(C.TEXTO_COM) LIKE '%GRACIAS%'
        OR UPPER(C.TEXTO_COM) LIKE '%PRECIO%')
    GROUP BY P.ID_PUB, P.DES_PUB
    ORDER BY COMENTARIOS_FAVORABLES DESC
) WHERE ROWNUM = 1;

-- 5. Publicacion mas compartida
SELECT * FROM (
    SELECT ORIG.ID_PUB AS ID_PUBLICACION, 
           ORIG.DES_PUB AS CONTENIDO,
           COUNT(COPIA.ID_PUB) AS VECES_COMPARTIDA
    FROM PUBLICACIONES ORIG
    JOIN PUBLICACIONES COPIA ON ORIG.ID_PUB = COPIA.ID_PUB_ORI
    GROUP BY ORIG.ID_PUB, ORIG.DES_PUB
    ORDER BY VECES_COMPARTIDA DESC
) WHERE ROWNUM = 1;